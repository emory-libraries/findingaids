<?xml version="1.0" encoding="UTF-8"?>
<!-- 

  Define xqueries to be used to retrieve xml data from database needed
  to generate OAI.

  The xquery is compiled from: declaration, for, let, where, and return

  Alternate sections for each of these may be specified for particular
  OAI verbs and metadata format using verb and metadata
  attributes. (Note that the metadata attribute is meaningless without
  a verb and will be ignored.)the

  Validation against xquery.xsd is a bare minimum, but does not ensure
  xqueries are declared correctly; to review your compiled queries,
  enable xmldbOAI debug mode.

-->
<xquery>
    <declare><![CDATA[
      declare namespace xs = "http://www.w3.org/2001/XMLSchema";
      ]]>
    </declare>
<!-- note: geu-s restricts to emory finding aids only -->
    <for><![CDATA[
      for $a in /ead[eadheader/eadid/@mainagencycode = 'geu-s']
      ]]>
    </for>
    <let><![CDATA[
      let $time := xmldb:last-modified(util:collection-name($a), util:document-name($a))
      let $oaitime := replace($time, "\-04:00", "Z")
      ]]>                
    </let>
    <where verb="GetRecord"><![CDATA[
        $a/@id = "?"
        ]]>
    </where>
    <where>
 <!-- DEFAULT query is used when a set is not requested and should return all records -->
      <set setSpec="DEFAULT" />                   

      <from><![CDATA[
         $time >= xs:dateTime("?")
         ]]>
      </from>
      <until><![CDATA[
         $time <= xs:dateTime("?")
         ]]>
      </until>                    
    </where>
<!-- default result : return for GetRecord or ListRecords -->
    <return><![CDATA[
      return <ead>
               {$a/@id}
               {$a/eadheader}
	       <archdesc>
		 {$a/archdesc/did}
  	         {$a/archdesc/controlaccess}
  	         {$a/archdesc/accessrestrict}
	       </archdesc>
               <LastModified>{$oaitime}</LastModified>                       
	     </ead>
       ]]>                
     </return>
<!-- result to return for ListIdentifiers -->
    <return verb="ListIdentifiers"><![CDATA[
      return <ead>
               {$a/@id}
               <LastModified>{$oaitime}</LastModified>
             </ead>
      ]]>                
    </return>
  </xquery>
